<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenWebUI Chat Analyzer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked@4.0.0/marked.min.js"></script>
    <style>
        body {
            padding: 20px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .card {
            margin-bottom: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 30px;
        }
        #chat-details {
            height: 400px;
            overflow-y: auto;
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .message-user {
            background-color: #e9ecef;
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 10px;
        }
        .message-assistant {
            background-color: #d1e7dd;
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 10px;
        }
        /* Markdown styling */
        .message-user code, .message-assistant code {
            background-color: rgba(0,0,0,0.05);
            padding: 2px 4px;
            border-radius: 3px;
            font-family: monospace;
        }
        .message-user pre, .message-assistant pre {
            background-color: rgba(0,0,0,0.05);
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
            margin: 10px 0;
        }
        .message-user pre code, .message-assistant pre code {
            background-color: transparent;
            padding: 0;
        }
        .message-user blockquote, .message-assistant blockquote {
            border-left: 4px solid #ced4da;
            padding-left: 10px;
            margin-left: 0;
            color: #6c757d;
        }
        .message-user table, .message-assistant table {
            border-collapse: collapse;
            margin: 10px 0;
            width: 100%;
        }
        .message-user th, .message-user td, .message-assistant th, .message-assistant td {
            border: 1px solid #dee2e6;
            padding: 8px;
        }
        .message-user th, .message-assistant th {
            background-color: rgba(0,0,0,0.05);
        }
        .filters {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .loading {
            text-align: center;
            padding: 50px;
            font-size: 24px;
            color: #6c757d;
        }
        .spinner-border {
            width: 3rem;
            height: 3rem;
        }
        .source-item {
            font-size: 0.85rem;
            margin-bottom: 5px;
        }
        .file-upload-container {
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 5px;
            margin-bottom: 20px;
            border: 2px dashed #dee2e6;
            text-align: center;
            cursor: pointer;
        }
        .file-upload-container:hover {
            background-color: #e9ecef;
        }
        .file-info {
            margin-top: 10px;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <h1 class="mb-4">OpenWebUI Chat Analyzer</h1>
        
        <div id="file-upload-section" class="card mb-4">
            <div class="card-header">
                <h5>Upload Chat Data</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <label for="json-file" class="file-upload-container" id="upload-area">
                            <div>
                                <i class="bi bi-upload fs-3"></i>
                                <h5>Drag & drop your JSON file here or click to browse</h5>
                                <p class="text-muted">Upload your OpenWebUI chats export file</p>
                            </div>
                            <input type="file" id="json-file" accept=".json" style="display: none;">
                        </label>
                        <div id="file-info" class="file-info text-muted"></div>
                    </div>
                    <div class="col-md-4">
                        <div class="alert alert-info">
                            <h5>How to get your chat data</h5>
                            <ol>
                                <li>Open your OpenWebUI instance</li>
                                <li>Go to "Admin Panel" > "Settings" tab</li>
                                <li>Select "Export all chats"</li>
                                <li>Upload the downloaded file here</li>
                            </ol>
                        </div>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <button id="analyze-default-file" class="btn btn-outline-secondary">Use Sample Data (all-chats.json)</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="loading" class="loading" style="display: none;">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p>Loading and analyzing chat data...</p>
            <p class="text-muted">This may take a while for large JSON files</p>
        </div>

        <div id="main-content" style="display: none;">
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5>Data Overview</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3 mb-3">
                                    <div class="card text-white bg-primary">
                                        <div class="card-body">
                                            <h5 class="card-title">Total Chats</h5>
                                            <h2 id="total-chats">0</h2>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <div class="card text-white bg-success">
                                        <div class="card-body">
                                            <h5 class="card-title">Unique Users</h5>
                                            <h2 id="unique-users">0</h2>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <div class="card text-white bg-info">
                                        <div class="card-body">
                                            <h5 class="card-title">Total Messages</h5>
                                            <h2 id="total-messages">0</h2>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <div class="card text-white bg-warning">
                                        <div class="card-body">
                                            <h5 class="card-title">Models Used</h5>
                                            <h2 id="models-used">0</h2>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5>Filters</h5>
                        </div>
                        <div class="card-body filters">
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label for="date-filter" class="form-label">Date Range</label>
                                    <select class="form-select" id="date-filter">
                                        <option value="all">All Time</option>
                                        <option value="today">Today</option>
                                        <option value="week">Last 7 Days</option>
                                        <option value="month">Last 30 Days</option>
                                        <option value="year">This Year</option>
                                    </select>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="model-filter" class="form-label">Model</label>
                                    <select class="form-select" id="model-filter">
                                        <option value="all">All Models</option>
                                    </select>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="user-filter" class="form-label">User</label>
                                    <select class="form-select" id="user-filter">
                                        <option value="all">All Users</option>
                                    </select>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-12">
                                    <button id="apply-filters" class="btn btn-primary">Apply Filters</button>
                                    <button id="reset-filters" class="btn btn-outline-secondary">Reset</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5>Chats by Model</h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="model-chart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5>Chats Over Time</h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="time-chart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5>Message Distribution</h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="message-chart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5>Sources Referenced</h5>
                        </div>
                        <div class="card-body">
                            <div id="sources-container">
                                <div class="chart-container">
                                    <canvas id="sources-chart"></canvas>
                                </div>
                                <div id="top-sources" class="mt-3">
                                    <h6>Top Referenced Sources:</h6>
                                    <div id="top-sources-list"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5>Chat List</h5>
                            <div>
                                <input type="text" id="search-chat" class="form-control" placeholder="Search chats...">
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead>
                                        <tr>
                                            <th>Title</th>
                                            <th>User</th>
                                            <th>Model</th>
                                            <th>Messages</th>
                                            <th>Created</th>
                                            <th>Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="chat-list">
                                        <!-- Chat rows will be inserted here -->
                                    </tbody>
                                </table>
                                <div id="pagination" class="d-flex justify-content-center">
                                    <!-- Pagination will be inserted here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5>Chat Details</h5>
                        </div>
                        <div class="card-body">
                            <div id="chat-details">
                                <p class="text-center text-muted">Select a chat to view details</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal for Message View -->
        <div class="modal fade" id="message-modal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Chat Conversation</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body" id="message-container">
                        <!-- Messages will be inserted here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Main data object
        let chatData = [];
        let filteredData = [];
        const PAGE_SIZE = 10;
        let currentPage = 0;
        let messageModal;
        let fileUploaded = false;
        let fileName = '';

        // Chart instances to allow destruction before recreating
        let modelChart = null;
        let timeChart = null;
        let messageChart = null;
        let sourcesChart = null;

        // Initialize the application
        document.addEventListener('DOMContentLoaded', async () => {
            setupFileUpload();
            setupDefaultFileButton();
            
            // Initialize modal
            messageModal = new bootstrap.Modal(document.getElementById('message-modal'));
        });

        // Setup file upload functionality
        function setupFileUpload() {
            const fileInput = document.getElementById('json-file');
            const uploadArea = document.getElementById('upload-area');
            const fileInfo = document.getElementById('file-info');
            
            // Handle file selection
            fileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    handleFileUpload(file);
                }
            });
            
            // Handle drag and drop
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('bg-light');
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('bg-light');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('bg-light');
                
                const file = e.dataTransfer.files[0];
                if (file && file.type === 'application/json') {
                    fileInput.files = e.dataTransfer.files;
                    handleFileUpload(file);
                } else {
                    fileInfo.innerHTML = '<div class="alert alert-danger">Please upload a JSON file</div>';
                }
            });
        }
        
        // Setup button to use the default all-chats.json file
        function setupDefaultFileButton() {
            const analyzeDefaultButton = document.getElementById('analyze-default-file');
            
            analyzeDefaultButton.addEventListener('click', async () => {
                document.getElementById('file-upload-section').style.display = 'none';
                document.getElementById('loading').style.display = 'block';
                
                try {
                    // Load default chat data
                    await loadDefaultChatData();
                } catch (error) {
                    handleDataLoadError(error);
                }
            });
        }
        
        // Handle file upload and processing
        function handleFileUpload(file) {
            const fileInfo = document.getElementById('file-info');
            
            // Display file info
            fileName = file.name;
            const fileSizeMB = (file.size / (1024 * 1024)).toFixed(2);
            fileInfo.innerHTML = `<div class="alert alert-success">
                <strong>${fileName}</strong> (${fileSizeMB} MB) selected
                <button id="process-file" class="btn btn-primary btn-sm ms-3">Analyze This File</button>
            </div>`;
            
            // Add event listener to the process button
            document.getElementById('process-file').addEventListener('click', () => {
                document.getElementById('file-upload-section').style.display = 'none';
                document.getElementById('loading').style.display = 'block';
                
                const reader = new FileReader();
                
                reader.onload = async (e) => {
                    try {
                        const jsonData = JSON.parse(e.target.result);
                        chatData = jsonData;
                        fileUploaded = true;
                        
                        console.log(`Loaded ${chatData.length} chats from uploaded file`);
                        
                        // Hide loading indicator and show main content
                        document.getElementById('loading').style.display = 'none';
                        document.getElementById('main-content').style.display = 'block';
                        
                        // Process the data
                        processData(chatData);
                        
                        // Setup event listeners
                        setupEventListeners();
                        
                    } catch (error) {
                        handleDataLoadError(error);
                    }
                };
                
                reader.onerror = () => {
                    handleDataLoadError(new Error('Error reading the file'));
                };
                
                reader.readAsText(file);
            });
        }
        
        // Load the default all-chats.json file
        async function loadDefaultChatData() {
            const response = await fetch('all-chats.json');
            if (!response.ok) {
                throw new Error('Failed to load default chat data');
            }
            
            chatData = await response.json();
            console.log(`Loaded ${chatData.length} chats from default file`);
            
            // Hide loading indicator and show main content
            document.getElementById('loading').style.display = 'none';
            document.getElementById('main-content').style.display = 'block';
            
            // Process the data
            processData(chatData);
            
            // Setup event listeners
            setupEventListeners();
        }
        
        // Handle data loading errors
        function handleDataLoadError(error) {
            console.error('Error loading or processing data:', error);
            document.getElementById('loading').innerHTML = `
                <div class="alert alert-danger">
                    <h4>Error Loading Data</h4>
                    <p>${error.message}</p>
                    <p>Make sure your JSON file is valid and has the correct structure.</p>
                    <button id="back-to-upload" class="btn btn-primary mt-3">Back to Upload</button>
                </div>
            `;
            
            document.getElementById('back-to-upload').addEventListener('click', () => {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('file-upload-section').style.display = 'block';
            });
        }

        // Process and display the data
        function processData(data) {
            filteredData = [...data];
            
            // Populate overview statistics
            displayOverviewStats(data);
            
            // Generate charts
            generateCharts(data);
            
            // Populate the filters
            populateFilters(data);
            
            // Display chat list
            displayChatList(filteredData, currentPage);
        }

        // Display overview statistics
        function displayOverviewStats(data) {
            // Calculate total chats
            document.getElementById('total-chats').textContent = data.length;
            
            // Calculate unique users
            const uniqueUsers = new Set(data.map(chat => chat.user_id));
            document.getElementById('unique-users').textContent = uniqueUsers.size;
            
            // Calculate total messages
            let totalMessages = 0;
            data.forEach(chat => {
                if (chat.chat && chat.chat.messages) {
                    totalMessages += chat.chat.messages.length;
                } else if (chat.chat && chat.chat.history && chat.chat.history.messages) {
                    totalMessages += Object.keys(chat.chat.history.messages).length;
                }
            });
            document.getElementById('total-messages').textContent = totalMessages;
            
            // Calculate models used
            const uniqueModels = new Set();
            data.forEach(chat => {
                if (chat.chat && chat.chat.models) {
                    chat.chat.models.forEach(model => uniqueModels.add(model));
                }
            });
            document.getElementById('models-used').textContent = uniqueModels.size;
        }

        // Generate charts
        function generateCharts(data) {
            // Destroy existing charts before creating new ones
            destroyCharts();
            
            // Model usage chart
            generateModelChart(data);
            
            // Time-based chart
            generateTimeChart(data);
            
            // Message distribution chart
            generateMessageChart(data);
            
            // Sources chart
            generateSourcesChart(data);
        }

        // Destroy all existing charts to prevent errors when regenerating
        function destroyCharts() {
            if (modelChart) {
                modelChart.destroy();
                modelChart = null;
            }
            
            if (timeChart) {
                timeChart.destroy();
                timeChart = null;
            }
            
            if (messageChart) {
                messageChart.destroy();
                messageChart = null;
            }
            
            if (sourcesChart) {
                sourcesChart.destroy();
                sourcesChart = null;
            }
        }

        // Generate model usage chart
        function generateModelChart(data) {
            const modelCounts = {};
            
            data.forEach(chat => {
                if (chat.chat && chat.chat.models) {
                    chat.chat.models.forEach(model => {
                        modelCounts[model] = (modelCounts[model] || 0) + 1;
                    });
                }
            });
            
            const ctx = document.getElementById('model-chart').getContext('2d');
            modelChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(modelCounts),
                    datasets: [{
                        label: 'Number of Chats',
                        data: Object.values(modelCounts),
                        backgroundColor: 'rgba(54, 162, 235, 0.6)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    },
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        // Generate time-based chart
        function generateTimeChart(data) {
            // Group chats by date (monthly)
            const chatsByMonth = {};
            
            data.forEach(chat => {
                const date = new Date(chat.created_at * 1000);
                const month = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                
                chatsByMonth[month] = (chatsByMonth[month] || 0) + 1;
            });
            
            // Sort by date
            const sortedMonths = Object.keys(chatsByMonth).sort();
            
            const ctx = document.getElementById('time-chart').getContext('2d');
            timeChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sortedMonths,
                    datasets: [{
                        label: 'Number of Chats',
                        data: sortedMonths.map(month => chatsByMonth[month]),
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 2,
                        tension: 0.1
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    },
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        // Generate message distribution chart
        function generateMessageChart(data) {
            const messageDistribution = {
                user: 0,
                assistant: 0
            };
            
            data.forEach(chat => {
                if (chat.chat && chat.chat.messages) {
                    chat.chat.messages.forEach(msg => {
                        if (msg.role === 'user') {
                            messageDistribution.user++;
                        } else if (msg.role === 'assistant') {
                            messageDistribution.assistant++;
                        }
                    });
                } else if (chat.chat && chat.chat.history && chat.chat.history.messages) {
                    Object.values(chat.chat.history.messages).forEach(msg => {
                        if (msg.role === 'user') {
                            messageDistribution.user++;
                        } else if (msg.role === 'assistant') {
                            messageDistribution.assistant++;
                        }
                    });
                }
            });
            
            const ctx = document.getElementById('message-chart').getContext('2d');
            messageChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['User Messages', 'Assistant Messages'],
                    datasets: [{
                        data: [messageDistribution.user, messageDistribution.assistant],
                        backgroundColor: [
                            'rgba(255, 159, 64, 0.6)',
                            'rgba(75, 192, 192, 0.6)'
                        ],
                        borderColor: [
                            'rgba(255, 159, 64, 1)',
                            'rgba(75, 192, 192, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        // Generate sources chart
        function generateSourcesChart(data) {
            const sourceTypes = {};
            const sourcesById = {};
            
            // Count sources by type
            data.forEach(chat => {
                if (chat.chat && chat.chat.history && chat.chat.history.messages) {
                    Object.values(chat.chat.history.messages).forEach(msg => {
                        if (msg.sources) {
                            msg.sources.forEach(source => {
                                if (source.source && source.source.type) {
                                    const type = source.source.type;
                                    sourceTypes[type] = (sourceTypes[type] || 0) + 1;
                                }
                                
                                // Track individual sources
                                if (source.source && source.source.id) {
                                    const id = source.source.id;
                                    if (!sourcesById[id]) {
                                        sourcesById[id] = {
                                            count: 0,
                                            name: source.source.name || 'Unknown',
                                            type: source.source.type || 'Unknown'
                                        };
                                    }
                                    sourcesById[id].count++;
                                }
                            });
                        }
                    });
                }
            });
            
            // Display chart for source types
            const ctx = document.getElementById('sources-chart').getContext('2d');
            sourcesChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(sourceTypes),
                    datasets: [{
                        data: Object.values(sourceTypes),
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.6)',
                            'rgba(54, 162, 235, 0.6)',
                            'rgba(255, 206, 86, 0.6)',
                            'rgba(75, 192, 192, 0.6)',
                            'rgba(153, 102, 255, 0.6)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
            
            // Display top sources
            const topSourcesList = document.getElementById('top-sources-list');
            topSourcesList.innerHTML = ''; // Clear existing content
            
            // Sort sources by count
            const sortedSources = Object.entries(sourcesById)
                .map(([id, info]) => ({ id, ...info }))
                .sort((a, b) => b.count - a.count)
                .slice(0, 10); // Top 10
                
            sortedSources.forEach(source => {
                const sourceElement = document.createElement('div');
                sourceElement.className = 'source-item';
                sourceElement.innerHTML = `
                    <strong>${source.name}</strong> (${source.type})
                    <span class="badge bg-secondary">${source.count} references</span>
                `;
                topSourcesList.appendChild(sourceElement);
            });
        }

        // Populate filter dropdowns
        function populateFilters(data) {
            // Populate model filter
            const modelFilter = document.getElementById('model-filter');
            const models = new Set();
            
            data.forEach(chat => {
                if (chat.chat && chat.chat.models) {
                    chat.chat.models.forEach(model => models.add(model));
                }
            });
            
            models.forEach(model => {
                const option = document.createElement('option');
                option.value = model;
                option.textContent = model;
                modelFilter.appendChild(option);
            });
            
            // Populate user filter
            const userFilter = document.getElementById('user-filter');
            const users = new Map();
            
            data.forEach(chat => {
                users.set(chat.user_id, chat.user_id);
            });
            
            users.forEach((displayName, userId) => {
                const option = document.createElement('option');
                option.value = userId;
                option.textContent = `User ${displayName.substring(0, 8)}...`;
                userFilter.appendChild(option);
            });
        }

        // Display chat list with pagination
        function displayChatList(data, page) {
            const chatList = document.getElementById('chat-list');
            chatList.innerHTML = '';
            
            const startIdx = page * PAGE_SIZE;
            const endIdx = Math.min(startIdx + PAGE_SIZE, data.length);
            
            for (let i = startIdx; i < endIdx; i++) {
                const chat = data[i];
                const row = document.createElement('tr');
                
                // Format creation date
                const createdDate = new Date(chat.created_at * 1000).toLocaleString();
                
                // Count messages
                let messageCount = 0;
                if (chat.chat && chat.chat.messages) {
                    messageCount = chat.chat.messages.length;
                } else if (chat.chat && chat.chat.history && chat.chat.history.messages) {
                    messageCount = Object.keys(chat.chat.history.messages).length;
                }
                
                // Get model
                let model = 'Unknown';
                if (chat.chat && chat.chat.models && chat.chat.models.length > 0) {
                    model = chat.chat.models.join(', ');
                }
                
                row.innerHTML = `
                    <td>${chat.title || 'Untitled'}</td>
                    <td>${chat.user_id.substring(0, 8)}...</td>
                    <td>${model}</td>
                    <td>${messageCount}</td>
                    <td>${createdDate}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary view-chat" data-index="${i}">View</button>
                        <button class="btn btn-sm btn-outline-secondary view-messages" data-index="${i}">Messages</button>
                    </td>
                `;
                
                chatList.appendChild(row);
            }
            
            // Setup pagination
            displayPagination(data.length, page);
            
            // Add event listeners for buttons
            document.querySelectorAll('.view-chat').forEach(button => {
                button.addEventListener('click', (e) => {
                    const index = parseInt(e.target.getAttribute('data-index'));
                    displayChatDetails(filteredData[index]);
                });
            });
            
            document.querySelectorAll('.view-messages').forEach(button => {
                button.addEventListener('click', (e) => {
                    const index = parseInt(e.target.getAttribute('data-index'));
                    displayMessages(filteredData[index]);
                });
            });
        }

        // Display pagination controls
        function displayPagination(totalItems, currentPage) {
            const totalPages = Math.ceil(totalItems / PAGE_SIZE);
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';
            
            if (totalPages <= 1) return;
            
            const nav = document.createElement('nav');
            const ul = document.createElement('ul');
            ul.className = 'pagination';
            
            // Previous button
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${currentPage === 0 ? 'disabled' : ''}`;
            const prevLink = document.createElement('a');
            prevLink.className = 'page-link';
            prevLink.href = '#';
            prevLink.textContent = 'Previous';
            prevLink.addEventListener('click', (e) => {
                e.preventDefault();
                if (currentPage > 0) {
                    currentPage--;
                    displayChatList(filteredData, currentPage);
                }
            });
            prevLi.appendChild(prevLink);
            ul.appendChild(prevLi);
            
            // Page numbers
            const startPage = Math.max(0, currentPage - 2);
            const endPage = Math.min(totalPages - 1, currentPage + 2);
            
            for (let i = startPage; i <= endPage; i++) {
                const pageLi = document.createElement('li');
                pageLi.className = `page-item ${i === currentPage ? 'active' : ''}`;
                
                const pageLink = document.createElement('a');
                pageLink.className = 'page-link';
                pageLink.href = '#';
                pageLink.textContent = i + 1;
                pageLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    currentPage = i;
                    displayChatList(filteredData, currentPage);
                });
                
                pageLi.appendChild(pageLink);
                ul.appendChild(pageLi);
            }
            
            // Next button
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${currentPage === totalPages - 1 ? 'disabled' : ''}`;
            const nextLink = document.createElement('a');
            nextLink.className = 'page-link';
            nextLink.href = '#';
            nextLink.textContent = 'Next';
            nextLink.addEventListener('click', (e) => {
                e.preventDefault();
                if (currentPage < totalPages - 1) {
                    currentPage++;
                    displayChatList(filteredData, currentPage);
                }
            });
            nextLi.appendChild(nextLink);
            ul.appendChild(nextLi);
            
            nav.appendChild(ul);
            pagination.appendChild(nav);
        }

        // Display chat details
        function displayChatDetails(chat) {
            const chatDetails = document.getElementById('chat-details');
            chatDetails.innerHTML = '';
            
            // Create a formatted representation of the chat
            const formattedChat = JSON.stringify(chat, null, 2);
            chatDetails.textContent = formattedChat;
        }

        // Display messages in modal
        function displayMessages(chat) {
            const messageContainer = document.getElementById('message-container');
            messageContainer.innerHTML = '';
            
            const title = document.createElement('h6');
            title.className = 'mb-3';
            title.textContent = chat.title || 'Untitled Chat';
            messageContainer.appendChild(title);
            
            let messages = [];
            if (chat.chat && chat.chat.messages) {
                messages = chat.chat.messages;
            } else if (chat.chat && chat.chat.history && chat.chat.history.messages) {
                // Convert object to array and sort by timestamp
                messages = Object.values(chat.chat.history.messages)
                    .sort((a, b) => a.timestamp - b.timestamp);
            }
            
            if (messages.length === 0) {
                const noMessages = document.createElement('p');
                noMessages.className = 'text-muted';
                noMessages.textContent = 'No messages in this chat.';
                messageContainer.appendChild(noMessages);
            } else {
                messages.forEach(message => {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = message.role === 'user' ? 'message-user' : 'message-assistant';
                    
                    const roleSpan = document.createElement('div');
                    roleSpan.className = 'fw-bold mb-1';
                    roleSpan.textContent = message.role === 'user' ? 'User' : 'Assistant';
                    messageDiv.appendChild(roleSpan);
                    
                    const contentDiv = document.createElement('div');
                    // Parse markdown in message content
                    contentDiv.innerHTML = marked.parse(message.content);
                    messageDiv.appendChild(contentDiv);
                    
                    // Add timestamp if available
                    if (message.timestamp) {
                        const timestampDiv = document.createElement('div');
                        timestampDiv.className = 'text-muted mt-1 small';
                        timestampDiv.textContent = new Date(message.timestamp * 1000).toLocaleString();
                        messageDiv.appendChild(timestampDiv);
                    }
                    
                    // Add source information for assistant messages
                    if (message.role === 'assistant' && message.sources && message.sources.length > 0) {
                        const sourcesDiv = document.createElement('div');
                        sourcesDiv.className = 'mt-2 small';
                        
                        const sourcesTitle = document.createElement('strong');
                        sourcesTitle.textContent = 'Sources:';
                        sourcesDiv.appendChild(sourcesTitle);
                        
                        const sourcesList = document.createElement('ul');
                        sourcesList.className = 'mb-0 mt-1';
                        
                        message.sources.forEach(sourceItem => {
                            if (sourceItem.source) {
                                const sourceListItem = document.createElement('li');
                                sourceListItem.textContent = sourceItem.source.name || 'Unknown source';
                                sourcesList.appendChild(sourceListItem);
                            }
                        });
                        
                        sourcesDiv.appendChild(sourcesList);
                        messageDiv.appendChild(sourcesDiv);
                    }
                    
                    messageContainer.appendChild(messageDiv);
                });
            }
            
            // Show the modal
            messageModal.show();
        }

        // Set up event listeners
        function setupEventListeners() {
            // Apply filters button
            document.getElementById('apply-filters').addEventListener('click', () => {
                applyFilters();
            });
            
            // Reset filters button
            document.getElementById('reset-filters').addEventListener('click', () => {
                resetFilters();
            });
            
            // Search input
            document.getElementById('search-chat').addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                if (searchTerm) {
                    filteredData = chatData.filter(chat => 
                        (chat.title && chat.title.toLowerCase().includes(searchTerm))
                    );
                } else {
                    filteredData = [...chatData];
                }
                
                currentPage = 0;
                displayChatList(filteredData, currentPage);
            });
        }

        // Apply filters to the data
        function applyFilters() {
            const dateFilter = document.getElementById('date-filter').value;
            const modelFilter = document.getElementById('model-filter').value;
            const userFilter = document.getElementById('user-filter').value;
            
            // Start with all data
            let filtered = [...chatData];
            
            // Apply date filter
            if (dateFilter !== 'all') {
                const now = new Date();
                let startDate;
                
                switch (dateFilter) {
                    case 'today':
                        startDate = new Date(now.setHours(0, 0, 0, 0));
                        break;
                    case 'week':
                        startDate = new Date(now.setDate(now.getDate() - 7));
                        break;
                    case 'month':
                        startDate = new Date(now.setDate(now.getDate() - 30));
                        break;
                    case 'year':
                        startDate = new Date(now.setMonth(0, 1));
                        break;
                }
                
                const startTimestamp = Math.floor(startDate.getTime() / 1000);
                filtered = filtered.filter(chat => chat.created_at >= startTimestamp);
            }
            
            // Apply model filter
            if (modelFilter !== 'all') {
                filtered = filtered.filter(chat => 
                    chat.chat && 
                    chat.chat.models && 
                    chat.chat.models.includes(modelFilter)
                );
            }
            
            // Apply user filter
            if (userFilter !== 'all') {
                filtered = filtered.filter(chat => chat.user_id === userFilter);
            }
            
            // Update filtered data and display
            filteredData = filtered;
            currentPage = 0;
            
            // Regenerate charts with filtered data
            generateCharts(filteredData);
            
            // Update the list
            displayChatList(filteredData, currentPage);
        }

        // Reset all filters
        function resetFilters() {
            document.getElementById('date-filter').value = 'all';
            document.getElementById('model-filter').value = 'all';
            document.getElementById('user-filter').value = 'all';
            document.getElementById('search-chat').value = '';
            
            filteredData = [...chatData];
            currentPage = 0;
            
            // Regenerate charts with all data
            generateCharts(filteredData);
            
            // Update the list
            displayChatList(filteredData, currentPage);
        }
    </script>
</body>
</html>